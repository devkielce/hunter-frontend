"use strict";(()=>{var e={};e.id=149,e.ids=[149],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},40260:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>d});var o=r(49303),a=r(88716),i=r(60670),n=r(87070),u=r(6943);let p=["sprzedaż","sprzedam","do sprzedania","cena","zł","pln","licytacja","nieruchomość","mieszkanie","dom","działka"];function l(e){let t=[e.title,e.text,e.message].filter(Boolean).map(String).join(" ").trim()||"Bez tytułu",r="string"==typeof e.postUrl?e.postUrl:"string"==typeof e.url?e.url:"",s=[];return Array.isArray(e.images)&&e.images.forEach(e=>"string"==typeof e&&s.push(e)),"string"==typeof e.image&&s.push(e.image),{title:t,source_url:r,source:"facebook",description:t,price_pln:null,city:null,location:null,images:s}}async function d(e){let t;let r=e.headers.get("x-apify-webhook-secret"),s=process.env.APIFY_WEBHOOK_SECRET;if(!s||r!==s)return n.NextResponse.json({error:"Unauthorized"},{status:401});try{t=await e.json()}catch{return n.NextResponse.json({error:"Invalid JSON"},{status:400})}if(t?.eventType&&"ACTOR.RUN.SUCCEEDED"!==t.eventType)return n.NextResponse.json({ok:!0,skipped:"eventType !== ACTOR.RUN.SUCCEEDED"});let o=t?.datasetId??t?.resource?.id;if(!o)return n.NextResponse.json({error:"Missing datasetId"},{status:400});let a=process.env.APIFY_TOKEN;if(!a)return n.NextResponse.json({error:"APIFY_TOKEN not configured"},{status:500});let i=`https://api.apify.com/v2/datasets/${o}/items?token=${a}`,d=await fetch(i);if(!d.ok)return console.error("Apify dataset fetch failed",d.status,await d.text()),n.NextResponse.json({error:"Failed to fetch dataset"},{status:502});let c=(await d.json()).filter(e=>{let t=[e.title,e.text,e.message].filter(Boolean).map(String).join(" ");return t&&function(e){let t=e.toLowerCase();return p.some(e=>t.includes(e))}(t)}).map(l),f=(0,u.l)(),m=0,h=0;for(let e of c){if(!e.source_url)continue;let{data:t}=await f.from("listings").select("id").eq("source_url",e.source_url).eq("source","facebook").maybeSingle(),r={...e,status:"new",notified:!1,updated_at:new Date().toISOString()};if(t){let{error:e}=await f.from("listings").update(r).eq("id",t.id);!e&&h++}else{let{error:e}=await f.from("listings").insert({...r,created_at:new Date().toISOString()});!e&&m++}}return n.NextResponse.json({ok:!0,total:c.length,inserted:m,updated:h})}let c=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/apify/webhook/route",pathname:"/api/apify/webhook",filename:"route",bundlePath:"app/api/apify/webhook/route"},resolvedPagePath:"/Users/arturwillonski/Documents/hunter-frontend/src/app/api/apify/webhook/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:h}=c,g="/api/apify/webhook/route";function y(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},6943:(e,t,r)=>{r.d(t,{l:()=>o});var s=r(37857);function o(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,s.eI)("https://zdmhdrpoeegqehphgufw.supabase.co",e,{auth:{persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,732,972],()=>r(40260));module.exports=s})();